# í”„ë¡œì íŠ¸ ë°°í¬ ê³¼ì •

> AWS í™˜ê²½ì—ì„œ NGINX ì›¹ì„œë²„ë¥¼ í†µí•´ í”„ë¡œì íŠ¸ë¥¼ ë°°í¬í•˜ì˜€ìŠµë‹ˆë‹¤.

## ì‚¬ìš©í•œ ì œí’ˆì˜ ì¢…ë¥˜ì™€ ì„¤ì •ê°’

- OS : Ubuntu 20.04
- JVM: OpenJDK-8
- WEB: Nginx (1.18.1)
- DB: MySQL (8.0.28 for Linux on x86_64)

## HTTPS ì ìš©

> certbotì„ ì´ìš©í•´ì„œ í•´ë‹¹ ë„ë©”ì¸ì˜ letsencryptë°©ì‹ì˜ SSL ì¸ì¦ì„œë¥¼ ë°œê¸‰ ë°›ì•˜ìŠµë‹ˆë‹¤.

#### Spring Boot HTTPS ì ìš©í•˜ëŠ” ê³¼ì •
ğŸ’¡ ì „ì œ ì¡°ê±´ : certbotì„ í†µí•´ letsencrypt ë°©ì‹ìœ¼ë¡œ ssl ì¸ì¦ì„œ ë°œê¸‰ ë°›ì€ ìƒíƒœ

1. pem í‚¤ ìœ„ì¹˜í•˜ëŠ” ê³³ìœ¼ë¡œ ì ‘ê·¼
    - /etc/letsencrypt/live/ë„ë©”ì¸ í´ë”ë¡œ ì´ë™

    ![ssl_key](/uploads/f98bcb520092da61d9c997b2745bc480/ssl_key.png)
    
2. spring boot ëŠ” pem í‚¤ ì¸ì‹í•˜ì§€ ëª»í•˜ë¯€ë¡œ pkcs12ë¡œ ë³€í™˜
    
    ```bash
    $ openssl pkcs12 -export -out keystore.p12 -in cert.pem -inkey key.pem
    ```
    
3. ìƒì„±ëœ keystore.p12íŒŒì¼ì„ ë¡œì»¬ì˜ spring boot í”„ë¡œì íŠ¸ resources í´ë”ë¡œ ì´ë™ (WinSCP ì‚¬ìš©) 
    
    ![applicaion_properties](/uploads/385d955729e8f47ac6df829951318cf6/applicaion_properties.png)
    
4. application.propertiesì— ì„¤ì • ì¶”ê°€

    ```bash
    server.ssl.key-store=classpath:keystore.p12
    server.ssl.key-store-type=PKCS12
    server.ssl.key-store-password= .p12ë¡œ ë³€í™˜í• ë•Œ ì„¤ì •í•œ ë¹„ë°€ë²ˆí˜¸
    server.http2.enabled=true
    ```
5. Spring Boot ì‹¤í–‰í•˜ë©´ ì ìš© ì™„ë£Œ


## FrontEnd

> ë¡œì»¬ì—ì„œ ```npm run build``` ëª…ë ¹ì–´ë¥¼ í†µí•´ Vue í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•˜ì˜€ìŠµë‹ˆë‹¤.

#### ë¹Œë“œ íŒŒì¼ ì ìš© ë°©ë²•

1. NGINX ì„¤ì •ì— ì‘ì„±í•œ ìœ„ì¹˜ì— íŒŒì¼ ì˜®ê¸°ê¸°.

2. ```sudo service nginx restart``` ëª…ë ¹ì–´ë¡œ nginx ì¬ì‹œì‘


## BackEnd

> ë¡œì»¬ì—ì„œ jar íŒŒì¼ë¡œ ë¹Œë“œí•˜ì˜€ìŠµë‹ˆë‹¤.

#### ë°±ì—”ë“œ ì„œë²„ ì‹¤í–‰ ë°©ë²•

```bash
# ì„œë²„ ì‹¤í–‰ ëª…ë ¹ì–´
java -jar íŒŒì¼ëª….jar

# ë°ëª¬ í˜•íƒœë¡œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ëª…ë ¹ì–´
nohup java -jar íŒŒì¼ëª….jar
```


## DATABASE ì„¤ì •

> ID: root
>
> PW: ssafy
>
> DBëª… : onfit



## NGINX ì„¤ì •

> Nginxì˜ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ í”„ë¡ íŠ¸ì™€ ë°±ì—”ë“œ ìš”ì²­ì„ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤. 

#### /etc/nginx/sites-available/default

```bash
server {
  listen 80; #80í¬íŠ¸ë¡œ ë°›ì„ ë•Œ
  server_name i6b110.p.ssafy.io; #ë„ë©”ì¸ì£¼ì†Œ, ì—†ì„ê²½ìš° localhost
  return 301 https://i6b110.p.ssafy.io$request_uri;

}
server {
  listen 443 ssl http2;
  server_name i6b110.p.ssafy.io;

  root /var/www/html/dist;  # ë¹Œë“œí•œ FrontEnd í´ë”ì˜ ìœ„ì¹˜
  index index.html;

  # ssl ì¸ì¦ì„œ ì ìš©í•˜ê¸°
  ssl_certificate /etc/letsencrypt/live/i6b110.p.ssafy.io/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/i6b110.p.ssafy.io/privkey.pem;

  location / { # /ë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ ì²˜ë¦¬
    try_files $uri $uri/ =404;
  }
  
  location /api { # /apië¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ ì²˜ë¦¬
    proxy_pass https://localhost:8081/api; # Requestì— ëŒ€í•´ ì–´ë””ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ëŠ”ì§€ ì‘ì„±. 8081 -> ìì‹ ì˜ springboot appì´ì‚¬ìš©í•˜ëŠ” í¬íŠ¸
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
server {
    if ($host = i6b110.p.ssafy.io) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


  listen 80;
  server_name i6b110.p.ssafy.io;
    return 404; # managed by Certbot
}
```
